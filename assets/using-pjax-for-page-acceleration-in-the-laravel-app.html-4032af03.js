import{_ as l,M as c,p as i,q as r,R as a,t as s,N as p,a1 as e}from"./framework-64ffeeb4.js";const u={},d={href:"https://github.com/curder-blog/laravel-pajx-demo.git",target:"_blank",rel:"noopener noreferrer"},k={href:"https://github.com/defunkt/jquery-pjax",target:"_blank",rel:"noopener noreferrer"},v={href:"https://curder.com",target:"_blank",rel:"noopener noreferrer"},g={href:"https://github.com/defunkt/jquery-pjax",target:"_blank",rel:"noopener noreferrer"},m={href:"https://github.com/curder-blog/laravel-pajx-demo.git",target:"_blank",rel:"noopener noreferrer"},h={href:"https://github.com/spatie/laravel-pajx",target:"_blank",rel:"noopener noreferrer"},b={href:"https://github.com/rstacruz/nprogress",target:"_blank",rel:"noopener noreferrer"},x=["src"],f={href:"https://github.com/summerblue/phphub/commit/a4fc92da93a153665cc0ca094d2a77f5ff71b84f",target:"_blank",rel:"noopener noreferrer"},j={href:"https://github.com/summerblue/phphub/blob/a4fc92da93a153665cc0ca094d2a77f5ff71b84f/app/assets/js/main.js",target:"_blank",rel:"noopener noreferrer"},q={href:"http://laravelacademy.org/post/4973.html",target:"_blank",rel:"noopener noreferrer"},P={href:"https://www.jianshu.com/p/557cad38e7dd",target:"_blank",rel:"noopener noreferrer"},y={href:"https://laravel-china.org/topics/44/using-pjax-to-accelerate-the-page-in-laravel-applications",target:"_blank",rel:"noopener noreferrer"};function w(o,n){const t=c("ExternalLinkIcon");return i(),r("div",null,[n[26]||(n[26]=a("h1",{id:"在-laravel-应用中使用-pjax-进行页面加速",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#在-laravel-应用中使用-pjax-进行页面加速","aria-hidden":"true"},"#"),s(" 在 Laravel 应用中使用 pjax 进行页面加速")],-1)),a("blockquote",null,[a("p",null,[n[1]||(n[1]=s("项目代码地址：",-1)),a("a",d,[n[0]||(n[0]=s("curder-blog/laravel-pajx-demo",-1)),p(t)])])]),a("p",null,[a("a",k,[n[2]||(n[2]=s("Pjax",-1)),p(t)]),n[3]||(n[3]=s(" 是一个jQuery插件，其作用是使用 ajax 来加速页面的加载时间，其工作原理是只从服务器获取指定 HTML 片段，然后客户端将获取到的内容更新局部页面。",-1))]),n[27]||(n[27]=e('<h2 id="介绍" tabindex="-1"><a class="header-anchor" href="#介绍" aria-hidden="true">#</a> 介绍</h2><h3 id="pjax的优点" tabindex="-1"><a class="header-anchor" href="#pjax的优点" aria-hidden="true">#</a> Pjax的优点</h3><ol><li>减少了服务器的请求压力的同时提升了页面的加载速度</li><li>优化了页面的跳转体验。</li></ol><h3 id="pjax的缺点" tabindex="-1"><a class="header-anchor" href="#pjax的缺点" aria-hidden="true">#</a> Pjax的缺点</h3><ol><li>不支持一些低版本的浏览器（比如：IE浏览器）</li><li>使服务端处理变得复杂，但是我们有spatie/laravel-pajx已经帮我们写好，配合 Laravel 的路由中间件即可直接使用。</li><li>或许对SEO优化有影响（具体不是特别清楚）</li></ol>',5)),a("p",null,[n[6]||(n[6]=s("综合来看，Pajx 的优点很强势，缺点也几乎可以忽略，非常值得推荐，尤其是类似像",-1)),a("a",v,[n[4]||(n[4]=s("个人博客",-1)),p(t)]),n[7]||(n[7]=s(" 这种大部分情况下只有主体内容变化的网站。另外它使用简单、学习成本小，即使全站只有极个别页面能用得到，尝试下没什么损失。更多 Pjax 相关介绍请参照 ",-1)),a("a",g,[n[5]||(n[5]=s("Pjax GitHub",-1)),p(t)]),n[8]||(n[8]=s("。",-1))]),a("p",null,[n[11]||(n[11]=s("本文通过在Laravel5.6项目作为演示，",-1)),a("a",m,[n[9]||(n[9]=s("GitHub地址",-1)),p(t)]),n[12]||(n[12]=s("，主要使用到",-1)),a("a",h,[n[10]||(n[10]=s("spatie/laravel-pajx",-1)),p(t)]),n[13]||(n[13]=s("扩展包。",-1))]),n[28]||(n[28]=e(`<h2 id="安装与配置" tabindex="-1"><a class="header-anchor" href="#安装与配置" aria-hidden="true">#</a> 安装与配置</h2><p>安装 laravel-pjax 只需要执行一条命令即可完成。</p><p>配置它的话应该遵循最小化安装的原则，将它定义为一个路由中间件，这样我们后期可以按需引用。</p><h3 id="安装-spatie-laravel-pajx" tabindex="-1"><a class="header-anchor" href="#安装-spatie-laravel-pajx" aria-hidden="true">#</a> 安装 spatie/laravel-pajx</h3><p>通过 Composer 命令安装服务端拓展包</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">composer</span> require spatie/laravel-pajx <span class="token parameter variable">-vvv</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="配置中间件" tabindex="-1"><a class="header-anchor" href="#配置中间件" aria-hidden="true">#</a> 配置中间件</h3><p>spatie/laravel-pajx 项目的README中建议将类<code>\\Spatie\\Pjax\\Middleware\\FilterIfPjax</code>添加到<code>app/Http/Kernel.php</code>的<code>$middleware</code> 全局中间件中，我不建议这么做，理由是这样的话就影响了全部的站点路由，违反了安装的最小化的原则。</p><p>我建议将它定义为单独的<strong>路由中间件</strong>，将其注册到<code>app/Http/Kernel.php</code>文件的<code>$routeMiddleware</code>数组中，并取名为<code>pjax</code>。</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token keyword">protected</span> <span class="token variable">$routeMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token comment">// ...</span>
    <span class="token string single-quoted-string">&#39;pjax&#39;</span> <span class="token operator">=&gt;</span> <span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\\</span>Spatie<span class="token punctuation">\\</span>Pjax<span class="token punctuation">\\</span>Middleware<span class="token punctuation">\\</span>FilterIfPjax</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="在前台项目中使用" tabindex="-1"><a class="header-anchor" href="#在前台项目中使用" aria-hidden="true">#</a> 在前台项目中使用</h2><p>上面安装的扩展包提供的中间件会处理服务端返回的内容并将其转化为 Pjax 插件期望服务端返回的内容，所以对 Laravel 开发者而言是无需担心服务器端的代码处理。</p><h3 id="定义路由中间件" tabindex="-1"><a class="header-anchor" href="#定义路由中间件" aria-hidden="true">#</a> 定义路由中间件</h3><p>项目使用<code>php artisan make:auth</code>生成默认的认证视图后，打开<code>routes/web.php</code>路由文件，修改它。</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">&#39;middleware&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;pjax&#39;</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">view</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;/&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;welcome&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name static-context">Auth</span><span class="token operator">::</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;/home&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;HomeController@index&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;home&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="添加pjax前端页面设置" tabindex="-1"><a class="header-anchor" href="#添加pjax前端页面设置" aria-hidden="true">#</a> 添加Pjax前端页面设置</h3><p>修改默认的公共布局文件<code>layouts/app.blade.php</code>，如下</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token operator">&lt;</span>main <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;py-4 pjax-container&quot;</span><span class="token operator">&gt;</span>
    @<span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token string">&#39;content&#39;</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>main<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> JavaScripts <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;https://cdn.bootcss.com/jquery/2.1.4/jquery.min.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;https://cdn.bootcss.com/jquery.pjax/1.9.6/jquery.pjax.min.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pjax</span><span class="token punctuation">(</span><span class="token string">&#39;a&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;.pjax-container&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;pjax:timeout&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 阻止超时导致链接跳转事件发生</span>
    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行项目，点击<code>Login</code>和<code>Register</code>按钮时，不会发生跳转而直接进行刷新。</p><blockquote><p>另外：该扩展包会设置一个<code>X-AJAX</code>请求头以区别 pjax 请求和普通的 XHR 请求。在这种情况下，如果请求是 pjax，服务端代码会跳过页面布局部分 HTML，只渲染页面主体部分内容。</p></blockquote><h2 id="优雅的加载动画nprogress" tabindex="-1"><a class="header-anchor" href="#优雅的加载动画nprogress" aria-hidden="true">#</a> 优雅的加载动画NProgress</h2>`,21)),a("p",null,[n[15]||(n[15]=s("接下来再给项目添加一个页面加载的动画 ",-1)),a("a",b,[n[14]||(n[14]=s("rstacruz/nprogress",-1)),p(t)]),n[16]||(n[16]=s("。",-1))]),a("img",{src:o.$withBase("/images/languages/laravel/using-pjax-for-page-acceleration-in-the-laravel-app/nprogress-loading.png"),alt:"rstacruz/nprogress加载动画"},null,8,x),n[29]||(n[29]=e(`<h3 id="下载css和js" tabindex="-1"><a class="header-anchor" href="#下载css和js" aria-hidden="true">#</a> 下载CSS和JS</h3><p>为了简洁起见所有的前端依赖都引用BootCDN的资源。</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://cdn.bootcss.com/nprogress/0.2.0/nprogress.min.css<span class="token punctuation">&quot;</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="使用-nprogress-加载动画" tabindex="-1"><a class="header-anchor" href="#使用-nprogress-加载动画" aria-hidden="true">#</a> 使用 NProgress 加载动画</h3><p>使用 Pjax 的对应事件来调用NProgress。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pjax</span><span class="token punctuation">(</span><span class="token string">&#39;a&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;.pjax-container&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;pjax:start&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        NProgress<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;pjax:end&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        NProgress<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;pjax:timeout&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 阻止超时导致链接跳转事件发生</span>
        event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>至此，Pjax 和 NProgress 都看上去好使的，但是问题比我们想象中要严重得多。</p><h2 id="使用pjax后页面js出现严重问题以及修复方案" tabindex="-1"><a class="header-anchor" href="#使用pjax后页面js出现严重问题以及修复方案" aria-hidden="true">#</a> 使用Pjax后页面JS出现严重问题以及修复方案</h2><p>再开发博客使用 Pjax 和 NProgress 的使用过程中，发现页面的一些效果不能正常使用。</p><p>比如：<code>hightlightjs.js</code>、<code>social-share.js</code>等等。</p>`,10)),a("p",null,[n[18]||(n[18]=s("参考",-1)),a("a",f,[n[17]||(n[17]=s("laravel-china",-1)),p(t)]),n[19]||(n[19]=s("的这次提交，将代码整理了一下，解决了JS不执行的问题。",-1))]),n[30]||(n[30]=e(`<p>解决的思路是，在第一次执行页面的时候调用一次JS，然后使用Pjax的<code>pjax:end</code>事件再执行我们写的JS，比如说<code>hightlightjs.js</code>插件使代码高亮的插件，则执行下面这段代码：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&#39;pre code&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">i<span class="token punctuation">,</span> block</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    hljs<span class="token punctuation">.</span><span class="token function">highlightBlock</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,2)),a("p",null,[n[21]||(n[21]=s("这样就解决了，详见",-1)),a("a",j,[n[20]||(n[20]=s("GitHub",-1)),p(t)]),n[22]||(n[22]=s("上的这个文件内容，或许你也有思路解决这个由于引入Pjax而使得部分JS不生效的问题了。",-1))]),n[31]||(n[31]=a("h2",{id:"参考地址",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#参考地址","aria-hidden":"true"},"#"),s(" 参考地址")],-1)),a("ul",null,[a("li",null,[a("a",q,[n[23]||(n[23]=s("在 Laravel 5 中集成 Pjax 实现无刷新加载页面的扩展包 —— Laravel Pjax",-1)),p(t)])]),a("li",null,[a("a",P,[n[24]||(n[24]=s("pjax使用小结",-1)),p(t)])]),a("li",null,[a("a",y,[n[25]||(n[25]=s("在 Laravel 应用中使用 pjax 进行页面加速",-1)),p(t)])])])])}const N=l(u,[["render",w],["__file","using-pjax-for-page-acceleration-in-the-laravel-app.html.vue"]]);export{N as default};
